<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>MINTVERSE</title>
	<meta property="og:image" content="../cover.png"/>

	<link href="https://cdn.jsdelivr.net/npm/taipei-sans-tc" rel="stylesheet" />
	<link
	  href="https://cdn.jsdelivr.net/npm/taipei-sans-tc/dist/Light/TaipeiSansTCBeta-Light.css"
	  rel="stylesheet"
	/>
	<link
	  href="https://cdn.jsdelivr.net/npm/taipei-sans-tc/dist/Bold/TaipeiSansTCBeta-Bold.css"
	  rel="stylesheet"
	/>

	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="../css/_reset.css">
	<link rel="stylesheet" href="../css/header.css">
	<link rel="stylesheet" href="../css/footer.css">
	<link rel="stylesheet" href="../css/found.css?0510">
	<link rel="stylesheet" href="../css/range.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.1/p5.min.js"></script>
	<script src="../js/jquery-3.6.0.min.js"></script>
	<script  src="../js/found/marquee.js"></script>
	<script  src="../js/found/lightBlink.js"></script>
	<script  src="../js/found/gradien.js"></script>
	<script  src="../js/found/timer.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jquery.marquee@1.6.0/jquery.marquee.min.js"></script>
	<script src="../js/found/sprite.js"></script>
	<script src="../js/found/sketch.js"></script>
	<script src="../js/found/dead.js"></script>
	<script src="../js/found/notedit.js"></script>
	<script src="../js/header.js"></script>
	<script src="../js/footer.js"></script>
	<script src="../js/gifjs/gif.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>
	<style>
		.loading{
			position: absolute;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.5);
		}
		.lds-ring {
		  display: inline-block;
		  position: relative;
		  width: 80px;
		  height: 80px;
		  position: absolute;
		  top: 50%;
		  left: 50%;
		  transform: translate(-50%, -50%);
		}
		.lds-ring div {
		  box-sizing: border-box;
		  display: block;
		  position: absolute;
		  width: 64px;
		  height: 64px;
		  margin: 8px;
		  border: 8px solid #FF0000;
		  border-radius: 50%;
		  animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
		  border-color: #FF0000 transparent transparent transparent;
		}
		.lds-ring div:nth-child(1) {
		  animation-delay: -0.45s;
		}
		.lds-ring div:nth-child(2) {
		  animation-delay: -0.3s;
		}
		.lds-ring div:nth-child(3) {
		  animation-delay: -0.15s;
		}
		@keyframes lds-ring {
		  0% {
		    transform: rotate(0deg);
		  }
		  100% {
		    transform: rotate(360deg);
		  }
		}
	</style>	
</head>
<body>
	<div id="app">
		<header>
		</header>
		<section class="intro" style="display:block;">
			<h1>
				歡迎加入<br>《第二宇宙辭典》<br>鑄造小組
			</h1>
			<p>在這「文字」已然死滅的時代，你能夠讀懂這串訊息，就代表你有資格加入我們。</p>
			<p>進入我們的鑄造系統後，你會獲得一個隨機分配的詞彙。那個詞彙，就是你要負責鑄造的詞條。詞條的鑄造原則如下：</p>
			<ul>
				<li>請盡量用精要的字數（10 - 100 字），容納最多的意義。</li>
				<li>面對每一詞彙，請先判斷它的「詞性」，再來編寫「意義」。</li>
				<li>這些詞彙的確切意義，已經隨著舊人類文明一同消逝了。因此，你沒有任何正確答案可以遵循，只能依靠你的直覺與想像——我們相信，像你這樣特別的人，基因裡必然銘刻了部分的線索。請相信你自己的答案。</li>
				<li>我們唯一確定的是：<span>「這些詞彙的意義，與現世人們的普遍理解絕對不同。」</span></li>
				<li>詞彙是有壽命的，請在它耗盡自己的時間以前，盡快完成鑄造。</li>
				<li>如果你尚無靈感，可以參考鑄造小組的示範註釋。</li>
			</ul>
			<p>這些詞彙，是由「第二宇宙辭典」鑄造小組，從舊文明考古遺中，挖掘出來的斷簡殘篇。我們目前不知道這些斷簡殘篇的意義和全貌。但如果有足夠多的人，進行了詞彙的鑄造——</p>
			<p>也許，我們就能「贖回」那個可能存在的「第二宇宙」</p>
			<label class="check">我已閱讀並同意參與條款
			  <input type="checkbox">
			  <span class="checkmark"></span>
			</label>
			<button>確認加入</button>
		</section>
		<section class="edit" style="display: none;">
			<h1>唯一鑄造的原則是：「這些詞彙的意義，與現世人們的普遍理解絕對不同。」</h1>
			<div id="empty" class="canvasWrap">
				<img class="initImg" src="../image/logo.svg" alt="">
				<img class="noReveal" style="display:none;width:100%;height:100%;" src="" alt="">
			</div>
			<div id="myCanvas" class="canvasWrap" style="display:none;">
				<div class="loading">
					<div class="lds-ring"><div></div><div></div><div></div><div></div></div>
				</div>
			</div>
			<div id="noedit" style="display:none;" class ="canvasWrap" >
				<div class="loading">
					<div class="lds-ring"><div></div><div></div><div></div><div></div></div>
				</div>
				<div class="countdown">
					<label for="">DEADLINE</label>
					<p></p>
				</div>
			</div>
			<div class="formContainer">
				<h4>錢包：<span>0x000000000000000000000</span></h4>
				<div class="select">
					<select name="" id="selectToken">
						    <option value="">選擇你所擁有的詞彙 Token ID</option>
					</select>
				</div>
				<div class="rule">
					<p class="rule">進入我們的鑄造系統後，你會獲得一個隨機分配的詞彙。那個詞彙，就是你要負責鑄造的詞條。詞條的鑄造原則如下：</p>
					<ul class="rule">
						<li>請盡量用精要的字數（10 - 100 字），容納最多的意義。</li>
						<li>面對每一詞彙，請先判斷它的「詞性」，再來編寫「意義」。</li>
						<li>這些詞彙的確切意義，已經隨著舊人類文明一同消逝了。因此，你沒有任何正確答案可以遵循，只能依靠你的直覺與想像——我們相信，像你這樣特別的人，基因裡必然銘刻了部分的線索。請相信你自己的答案。</li>
						<li>我們唯一確定的是：「這些詞彙的意義，與現世人們的普遍理解絕對不同。」</li>
						<li>詞彙是有壽命的，請在它耗盡自己的時間以前，盡快完成鑄造。</li>
						<li>如果你尚無靈感，可以參考鑄造小組的示範註釋。</li>
					</ul>
					<p class="rule">這些詞彙，是由「第二宇宙辭典」鑄造小組，從舊文明考古遺中，挖掘出來的斷簡殘篇。我們目前不知道這些斷簡殘篇的意義和全貌。但如果有足夠多的人，進行了詞彙的鑄造——</p>
					<p class="rule">也許，我們就能「贖回」那個可能存在的「第二宇宙」。</p>	
				</div>
				<div class="form" style="display: none">
					<p class="deadline">DEADLINE <span>00:00:00</span><br>時限內沒有完成鑄造，詞彙將會永久死亡。</p>
					<div class="inputWrap editForm">
						<label for="">鑄造者 (填寫1-10個中文字)</label>
						<input type="text" id="author">
					</div>
					<div class="selectWrap editForm">
						<label for="">詞性</label>
						<div class="select">
							<select name="" id="speech">
								<option value="1">無</option>
								<option value="2">名詞</option>
								<option value="3">動詞</option>
								<option value="4">形容詞</option>
								<option value="5">嘆詞</option>
								<option value="6">狀聲詞</option>
								<option value="7">代詞</option>
								<option value="8">連接詞</option>
								<option value="9">量詞</option>
								<option value="10">助詞</option>
								<option value="11">副詞</option>
							</select>
						</div>
						<div class="select">
							<select name="" id="speech1">
								<option value="">無</option>
							</select>
						</div>
					</div>
					<div class="inputWrap synonym editForm">
						<label for="">同義詞 (填寫1-4個，總字數不超過10個中文字)</label>
						<input type="text" id="synonym0">
						<input type="text" id="synonym1">
						<input type="text" id="synonym2">
						<input type="text" id="synonym3">
					</div>
					<div class="inputWrap editForm">
						<label for="textarea">註釋 (填寫 10-100 個中文字)</label>
						<textarea name="" id="textarea" rows="6"></textarea>
						<ul><li>如果你尚無靈感，可以參考鑄造小組的示範註釋。</li></ul>
					</div>
				</div>
				<div class="dead" style="display:none;">
					<p></p>
				</div>
			</div>
			<button class="disable">開始定義</button>
			<span class="openMaker">製作專屬GIF</span>
			<span class="download">下載PNG</span>
		</section>
		<div class="popset"></div>
		<footer>
		</footer>
		<div class="gifMaker">
			<div class="maker">
				<div class="cross">
				</div>
				<h3>GIF 孵化器</h3>
				<p>GIF settings:</p>
				<div class="quality range">
					<label for="quality">品質</label>
					<label for="">0</label>
				  	<input type="range" id="quality" name="quality"
				         min="0" max="10" value="0">
				    <span>0</span>
				    <span>10</span>
				</div>
				<div class="count range">
					<label for="count">張數</label>
					<label for="">0</label>
				  	<input type="range" id="count" name="count" 
				         min="0" max="100" value="0" step="10">
				    <span>0</span>
				    <span>100</span>
				</div>
				<button class="making">製作GIF<span></span></button>
				<button class="downloadGif" id="downloadGif" style="display: none;">下載GIF</button>
			</div>
		</div>
	</div>
    <!-- Web3 Integration -->
    <script type="text/javascript" src="https://unpkg.com/web3@1.6.0/dist/web3.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/web3modal@1.9.4/dist/index.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@walletconnect/web3-provider@1.6.6/dist/umd/index.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>
    <script src="../js/web3-integration.js"></script>
	<script src="../js/pop.js"></script>
	<link rel="stylesheet" href="../css/pop.css">
	<script>
		var signature;
		$(document).ready(function() {
			let deadP5, nftP5, noteditP5;
			let status = 0;
			let wallet_info;
			var timer = null;
			let gifUrl = '';
			let pngUrl = '';
			$('header').setHeader();
			$('footer').setFooter();
			$('.popset').setPop();
			console.log('header');
			//nft();
			//renderDead();
			//notedit();

			let nftDetail = {};
			

			$('.intro button').on('click', async function(event) {
				event.preventDefault();
				/* Act on the event */

				if($('.check input').is(":checked")){
					// connect wallet
		            let connected = await onConnect(); 

					if(connected){
						$('.popset').openPop({message:'連結錢包成功'});
						await sign_messages();

						$('.popset').openPop({message:'翻開你的錢包，檢查是否擁有Mintverse 詞彙NFT'});

			            // get wallet_info
			            wallet_info = await tokens_of_owner();
			            $(".formContainer >h4 >span").text(short_wallet(wallet_info.address));

			            if(wallet_info.nftIdList.length==0){
			            	$('.popset').openPop({message:'尚未擁有Mintverse 詞彙NFT',type:'failed'});
			            	onDisconnect();
			            	return;
			            }else{
			            	$('.popset').openPop({message:'檢查成功，現在你可以開始定義！'});
			            }

			            // create options for defining
						wallet_info.nftIdList.forEach( function(item, index) {
							// statements
							$("#selectToken").append($("<option></option>").attr("value", item.token).text(item.token));
						});
						// $("#selectToken").append($("<option></option>").attr("value", '882').text('882'));
						// display define page
						$('.intro').hide();
						$('.edit').show();
						window.scrollTo(0, 0);
					}else{
						$('.popset').openPop({message:'連結錢包失敗',type:'failed'});
					}
				}


			});
			$('#textarea').bind('input propertychange', function() {

		      if(this.value.length > 100){
		          $('#textarea').val($('#textarea').val().slice(0,100));
		      }
			});
			$('textarea').keydown(function(evt){
			    if (evt.keyCode == 13) {
			        evt.preventDefault();
			    }
			});
			$('.edit button').on('click',function(event) {
				event.preventDefault();
				/* Act on the event */
				if($(this).hasClass('disable'))return;
				if($(this).hasClass('submit')){
					$('.popset').openPop({message:'正在鑄造定義，請稍待1-3分鐘，請勿關閉或重整頁面。等狐狸錢包跳出後，確認gas後按簽署，才算完成。'});
					renderGif($('#myCanvas canvas')[0]);
					//saveToPngBlob();
				}else{
					changeView(2);
				}
			});
			$('.edit .download').on('click', function(event) {
				event.preventDefault();
				/* Act on the event */
				saveToPngBlob();
			});
			$('#selectToken').on('change', async function() {
				
			  	if(this.value == '' || this.value == wallet_info.nftIdList.token) {
			  		changeView('empty')
			  		return
			  	}		
			  	const endpoint = `https://api2.mintverse.world/api/mintverse/token/${this.value}`;
			  	let data = await $.ajax({
			  		type: "GET",
				    url: endpoint,
				    dataType: "json",
				    success: function (response) {
				    	removeFormData();
				    	nftDetail = response.token;
				      	changeView(nftDetail.status);
				      	//changeView(2);
				    },
				    error: function (thrownError) {
				      	console.log(thrownError);
				    }
			  	})
			  	//let valueIdx = $("#selectToken")[0].selectedIndex - 1;
			});

			$('#speech').on('change', function(event) {
				updateSelect();
			})
			function canvasToImg(){
				let url  = canvas.toDataURL('image/jpeg', 0.8); // 可指定 jpeg 品質
				//let blob = dataURItoBlob(url);
				//submitGif(blob);
			}
			// function dataURItoBlob(dataURI) {
			//     // convert base64/URLEncoded data component to raw binary data held in a string
			//     var byteString;
			//     if (dataURI.split(',')[0].indexOf('base64') >= 0)
			//         byteString = atob(dataURI.split(',')[1]);
			//     else
			//         byteString = unescape(dataURI.split(',')[1]);

			//     // separate out the mime component
			//     var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

			//     // write the bytes of the string to a typed array
			//     var ia = new Uint8Array(byteString.length);
			//     for (var i = 0; i < byteString.length; i++) {
			//         ia[i] = byteString.charCodeAt(i);
			//     }

			//     return new Blob([ia], {type:mimeString});
			// }
			function updateSelect(){
				return new Promise((resolve, reject) => {
					let selectIndex = $("#speech").find(":selected").index();
					$('#speech1').empty();
					$('#speech1').append($("<option></option>").attr("value", "0").text("無"));
					if(selectIndex == 0)return;
					$('#speech option').each(function(index){
						if(index == selectIndex || index == 0)return;
						$('#speech1').append($("<option></option>").attr("value", $(this).val()).text($(this).text()));
					})
					resolve();
				})
			}
			function changeView(status){
				console.log(nftDetail)
				$('.canvasWrap').hide();
				// "0:尚未被Mint, 1: 尚未開始寫作, 2: 開始寫作"
				removeCanvas();
				$('.edit .rule, .edit .form, .edit .dead, .edit #myCanvas, .edit #notedit, .edit .download').hide();
				$('canvas').remove();
				$('.loading').show();
				$(".openMaker").hide();
				switch (status) {
					case 'empty':
						$('.edit .rule').show();
						$('.edit #empty').show();
						$('.edit #empty .initImg').show();
						$('.edit #empty .noReveal').hide();
						$('.edit button').addClass('disable');
						$('.loading').hide();
						break;
					case 1:
						clearInterval(timer);
						if(nftDetail.current_time <= nftDetail.expire_time){
							$('.edit .form').show();
							$('.edit button').show();
							setCountdown(nftDetail.current_time * 1000, nftDetail.expire_time * 1000);
							$('#noedit').show();
							// $('#noedit .info .id').text(nftDetail.id);
							// $('#noedit .info ul li:nth-of-type(2)').text(nftDetail.article_title);
							// $('#noedit .info ul li:nth-of-type(3)').text('作家 ' + nftDetail.author);
							$('.editForm').hide();
							$('.edit button.disable').removeClass('disable');
							let fontId = '0000' + nftDetail.id.toString();
        					fontId = fontId.substr(-4);
							let data = {
								author:nftDetail.word.author,
								id:fontId,
								font:nftDetail.word.word
							}
							$('.edit button').removeClass('submit');
							notedit(data).then(success => {
							    if(success.status == 'finish'){
							    	noteditP5 = success.p5;
							    	$('.loading').hide();
							    }
							 }).catch(fail => {
							    console.log(fail);
							 });
						} else {
							$('.edit #myCanvas').show();
							$('.dead p').empty();
							$('.dead p').text(nftDetail.word.dead_description);
							$('.dead').show();
							$('.loading').hide();
							$('.submit').hide();
							deadP5 = renderDead(nftDetail.word.word);
						}
						break;
					case 2:
						$('.edit button').show();
						$('.edit .form').show();
						$('.edit #myCanvas').show();
						$('.edit button').removeClass('disable').addClass('submit').text('MINT 鑄造定義');
						$(".editForm").show();
						$(".deadline").hide();
						if(nftDetail.status == 2){
							$('.edit .download').show().css('display', 'block');
							$(".openMaker").show().attr('style', 'display: block !important');
						}else{
							$('.edit .download').hide();
						}
						let data = {
							author:nftDetail.word.author,
							id:nftDetail.id,
							font:nftDetail.word.word,
							//font:'分享',
							context:nftDetail.word.context,
							category:nftDetail.word.category,
							synonyms:nftDetail.word.synonyms,
							speechs:nftDetail.word.part_of_speechs,
							status:nftDetail.status,
							//status:2,
							definer:nftDetail.word.definer
						}
						nft(data).then(async success => {
							if(success.status == 'finish'){
								$('.loading').hide();
							   	nftP5 = success.p5;
							   	$('#author').val(data.definer);
							   	$('#textarea').val(data.context);

							   	data.synonyms.forEach(function(word,index){
							   		$(`#synonym${index}`).val(word);
							   	})
							   	$("#speech").val(data.speechs[0]);
							   	//$("#speech").val(2);
							   	if(data.speechs[0] != 0){
							   		await updateSelect().then(() =>{
										// console.log(data.speechs[1])
									 	$("#speech1").val(data.speechs[1]);	
									   	let selectIndex = $("#speech1").find(":selected").index();
									});
								}
								$('.formContainer .form > span').show();
							}
						}).catch(fail => {
							console.log(fail);
						});;
						break;
					case 3:
						$('.edit #empty .noReveal').attr("src", nftDetail.image_url);
						//$('.edit #empty .noReveal').attr("src", '../image/sample.gif');
						$('.edit #empty .initImg').hide();
						$('.edit #empty .noReveal').show();
						$('.edit #empty').show();
						$('.loading').hide();
						break;
					default:
						// statements_def
						break;
				}
			}
			function removeCanvas(){
				if(nftP5 != undefined)nftP5.remove();
				if(deadP5 != undefined)deadP5.remove();
				if(noteditP5 != undefined)noteditP5.remove();		
				delete nftP5;
				delete deadP5;
				delete noteditP5;
			}
			function removeFormData(){
				$("#speech").val(1);
				updateSelect();
				$('input').val("");
				$('texture').val("");
			}
			function setCountdown(start,end){
				var countDownDate = new Date(end).getTime();
				let startTime = start;
				// Update the count down every 1 second
				timer = setInterval(function() {

				  // Get today's date and time
				  //var now = new Date().getTime();
				  var now = new Date(startTime).getTime();
				  // Find the distance between now and the count down date
				  var distance = countDownDate - now;

				  // Time calculations for days, hours, minutes and seconds
				  var days = Math.floor(distance / (1000 * 60 * 60 * 24));
				  var hours = Math.floor( ((distance % (1000 * 60 * 60 * 24))+ (days * 24 * 1000 * 60 * 60)) / (1000 * 60 * 60));
				  var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
				  var seconds = Math.floor((distance % (1000 * 60)) / 1000);

				  // Display the result in the element with id="demo"
				  if(hours < 10)hours = "0" + hours.toString();
				  if(minutes < 10)minutes = "0" + minutes.toString();
				  if(seconds < 10)seconds = "0" + seconds.toString();
				  $('.countdown p').text(hours + " : "
				  + minutes + " : " + seconds);
				  $('.deadline span').text(hours + " : "
				  + minutes + " : " + seconds);
				  // If the count down is finished, write some text
				  if (distance < 0) {
				    clearInterval(timer);
				    $('.countdown p').text("Time Out");
				  }
				  startTime += 1000;
				}, 1000);
			}
			async function submitGif(blob){
				console.log(blob)
				let endpoint = `https://api2.mintverse.world/api/mintverse/word/v2/definition/${nftDetail.word.id}?signature=${signature}`;
				let binary = '';
				const blobToBinary = async (blob) => {
				  const buffer = await blob.arrayBuffer();
				  
				  const view = new Int8Array(buffer);
				  
				  return [...view].map((n) => n.toString(2)).join(' ');
				};
				blobToBinary(blob).then( success =>{
					binary = success;
				});

				let formData = new FormData();
				formData.enctype = "multipart/form-data";
				formData.append('file', blob); 

				axios.post(endpoint, formData, {
			        headers: {
			          "Content-Type": "multipart/form-data",
			        },
			      })
			      .then(async(res) => {
			        console.log(res.status);
			        if(res.status==200){
			        	// Upload GIF Successfully, send tx to contract
			        	console.log(res.data.gif_url);
			        	$('.popset').openPop({message:'定義準備完成，詞彙上鏈中....'});

			        	// get defined data
			        	let define_data = {
			        		"tokenId":$("#selectToken").val(),
							"definer":$("#author").val(),
							"partOfSpeech1":$("#speech").val(),
							"partOfSpeech2":$("#speech1").val(),
							"relatedWord":$("#synonym0").val()+"_"+$("#synonym1").val()+"_"+$("#synonym2").val()+"_"+$("#synonym3").val(),
							"description":$("#textarea").val()
			        	}

			        	// Start Define Word on contract
			        	let define_result = await define_word(define_data);
			        }else{
			        	// Upload failed
			        	console.log(res.data);
			        	$('.popset').openPop({message:'定義時上傳失敗，請再重新嘗試一次'});
			        }
			      })
			      .catch((err) => {
			        console.log(err);
			        $('.popset').openPop({message:'定義時上傳失敗，請再重新嘗試一次'});
			      });
			}
			function saveToPngBlob(){
				let cvs = $('#myCanvas canvas')[0];
				cvs.toBlob(function(blob) {
				    let url = URL.createObjectURL(blob);
				    window.open(URL.createObjectURL(blob));
				    downloadGif(url, "png");
				    //submitGif(blob)
				}, 'image/png');
			}
			function downloadGif(url, type){
				const link = document.createElement('a');
		        link.href = url;
		        if(type == 'png')
		        	link.setAttribute('download', `${nftDetail.id}.png`);
		        else
		        	link.setAttribute('download', `${nftDetail.id}.gif`);
		        document.body.appendChild(link);
		        link.click(); 
		        link.parentNode.removeChild(link);
			}
			$('.making').on('click', function(event) {
				event.preventDefault();
				/* Act on the event */
				renderGif($('#myCanvas canvas')[0],'noUpload')
			});
			$('#downloadGif').on('click', function(event) {
				event.preventDefault();
				/* Act on the event */
				downloadGif(gifUrl);
			});
			function resetMaker(){
				$('.downloadGif').hide();
				$('.making').removeClass('success').text("製作GIF").attr("disabled",false);
			}
			function renderGif(canvasDom,status){
					let renderFinished = 0;
					let timer = null;
					let canvas = canvasDom;
					let quality = 3
					let count = 1;
					if(status == 'noUpload'){
						quality = $('.quality input[type=range]').val();
						count = $('.count input[type=range]').val();
						$('.making').attr('disabled', true);
						$('.making').addClass('disable').text("製作中...");
					}
					var gif = new GIF({
					  workers: 2,
					  quality: quality,
					  workerScript:'../js/gifjs/gif.worker.js',
					  repeat:0
					});
					gif.on('finished', function(blob) {
						const url = window.URL.createObjectURL(new Blob([blob]));
						$('.edit .download').css('display', 'block');
						if(status == 'noUpload'){
							$('.making').removeClass('disable').addClass('success').text("製作完成").append('<span></span>');
							$('.downloadGif').show();
							gifUrl = url;
							//window.open(URL.createObjectURL(blob));
							$('.gifMaker button.success span').on('click', function(event) {
								event.preventDefault();
								/* Act on the event */
								$('.gifMaker button.success span').off();
								resetMaker();
								event.stopPropagation();
							});
						}else{
							$('.edit .download').show();
							$(".openMaker").show().attr('style', 'display: block !important');
							submitGif(blob)
						}
					  	
					});

					function addFrame(canvas) {
				        if (renderFinished) return;
				        if (gif.frames.length < count) {
				        	console.log('addframe')
				          	gif.addFrame(canvas, {delay: 200});
				        } else {
				        	clearInterval(timer);
				        	console.log('render')
					          gif.render();
					          renderFinished = true
					          addFrame = null
				        }
				    }
				    timer = setInterval(function(){
				    	addFrame(canvas);
				    },10);
			}
			$('.gifMaker .cross, .openMaker').on('click', function(event) {
				event.preventDefault();
				/* Act on the event */
				resetMaker();
				$('.gifMaker').toggle();
				bg($('.quality input[type=range]'), $('.quality input[type=range]').val());
				bg($('.count input[type=range]'), $('.count input[type=range]').val());
			});
			$('.quality input[type=range]').on('input', function () {
			    bg($(this), $(this).val());
			});
			$('.count input[type=range]').on('input', function () {
			    bg($(this), $(this).val());
			});
		  function bg(ele, n){
		  	if(ele[0].name == 'quality'){
			    ele.css({
			       'background-image':'-webkit-linear-gradient(left ,#FF0000 0%,#FF0000 '+n*10+'%,#fff '+n*10+'%, #fff 100%)'
			    });
			    $('.maker .quality label:nth-of-type(2)').css('left',`calc(${n*10}% + ${ (6 - n*0.8) }px)`);
			    $('.maker .quality label:nth-of-type(2)').text(n);
			}else {
				ele.css({
			       'background-image':'-webkit-linear-gradient(left ,#FF0000 0%,#FF0000 '+n+'%,#fff '+n+'%, #fff 100%)'
			    });
			    $('.maker .count label:nth-of-type(2)').css('left',`calc(${n}% + ${ (6 - n*0.08) }px )`);
			    $('.maker .count label:nth-of-type(2)').text(n);
			}
		  }

		})
	</script>
</body>
</html>